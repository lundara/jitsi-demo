<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embed Room - Jitsi Meet</title>
    <script src="https://meet.mahakarya.my.id/external_api.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }

        #jitsi-embed {
            width: 100%;
            height: 100%;
        }

        #jitsi-embed .watermark,
        #jitsi-embed .leftwatermark,
        #jitsi-embed .subject,
        #jitsi-embed .subject-text,
        #jitsi-embed .filmstrip__videos,
        #jitsi-embed .participants-count,
        #jitsi-embed .participants-pane-button,
        #jitsi-embed .meeting-header,
        #jitsi-embed .header-text,
        #jitsi-embed .time-elapsed,
        #jitsi-embed [class*="subject"],
        #jitsi-embed [class*="participants-count"],
        #jitsi-embed [class*="header"] {
            display: none !important;
        }

        /* Hide Jitsi UI elements for a cleaner embed look */
        /* Note: Some classes might change over time in Jitsi updates */
        #jitsi-embed .displayname,
        #jitsi-embed .videocontainer__toolbar,
        #jitsi-embed .videocontainer__hoverOverlay,
        #jitsi-embed .displayNameContainer,
        #jitsi-embed .avatar-container,
        #jitsi-embed .watermark,
        #jitsi-embed .leftwatermark,
        #jitsi-embed .filmstrip {
            display: none !important;
        }

        /* Custom Mic Button */
        .custom-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 1rem;
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: rgba(99, 102, 241, 0.2);
            /* var(--bg-card)ish but more visible */
            backdrop-filter: blur(10px);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .control-btn:hover {
            background: rgba(99, 102, 241, 0.4);
            transform: scale(1.1);
        }

        .control-btn.danger {
            background: rgba(239, 68, 68, 0.5);
            /* var(--danger) with opacity */
        }

        .control-btn.danger:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        .status-indicator {
            position: absolute;
            top: 0;
            right: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #000;
        }

        .status-indicator.on {
            background: #10b981;
            /* var(--success) */
        }

        .status-indicator.off {
            background: #ef4444;
            /* var(--danger) */
        }
    </style>
</head>

<body>
    <div id="jitsi-embed"></div>

    <!-- Custom Controls -->
    <!-- <div class="custom-controls">
        <button class="control-btn" id="micBtn" onclick="toggleMicrophone()" title="Mikrofon">
            <i data-lucide="mic" id="micIcon" style="width: 24px; height: 24px;"></i>
            <span class="status-indicator off" id="micStatus"></span>
        </button>
    </div> -->

    <script>
        let jitsiApi = null;
        let targetUserId = null;
        let isMicMuted = true; // Start muted as per config
        let currentPinnedId = null;

        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomName = urlParams.get('room');
            targetUserId = urlParams.get('participant') || urlParams.get('userid');

            if (!roomName) {
                document.body.innerHTML = '<div style="color: white; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif;">Parameter ?room=nama-room diperlukan</div>';
                return;
            }

            initEmbed(roomName);
        });

        function initEmbed(roomName) {
            const domain = 'meet.mahakarya.my.id';
            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.getElementById('jitsi-embed'),
                userInfo: {
                    displayName: 'Embed'
                },
                configOverwrite: {
                    defaultLogoUrl: '',
                    startWithAudioMuted: true,
                    startWithVideoMuted: true,
                    prejoinPageEnabled: false,
                    skipMeetingPrejoin: true,
                    disableDeepLinking: true,
                    disableInviteFunctions: true,
                    doNotStoreRoom: true,
                    startScreenSharing: false,
                    // Hide UI elements
                    toolbarButtons: [],
                    filmstrip: {
                        disableStageFilmstrip: true,
                        disableResizable: true,
                    },
                    disableConnectionIndicators: true,
                    disableModeratorIndicator: true,
                    disableReactions: true,
                    disableProfile: true,
                    prejoinPageEnabled: false,
                    prejoinConfig: {
                        enabled: false
                    },
                    enableWelcomePage: false,
                    disableInitialGUM: true,
                    enableNoAudioDetection: false,
                    enableNoisyMicDetection: false,
                    disablePermissionMediaError: true,
                    disableTileEnlargement: true,
                    disableResponsiveTiles: true,
                    videoQuality: {
                        disabled: true
                    },
                    disabledNotifications: [
                        'dialog.cameraPermissionDeniedError',
                        'dialog.micPermissionDeniedError',
                        'dialog.cameraConstraintFailedError',
                        'dialog.micConstraintFailedError'
                    ],
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: ['microphone'],
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    SHOW_BRAND_WATERMARK: false,
                    HIDE_INVITE_MORE_HEADER: true,
                    SHOW_POWERED_BY: false,
                    SHOW_PROMOTIONAL_CLOSE_PAGE: false,
                    filmStripOnly: false,
                    DISABLE_DOMINANT_SPEAKER_INDICATOR: true,
                    DISABLE_FOCUS_INDICATOR: true,
                    DISABLE_VIDEO_BACKGROUND: true,
                    DISABLE_PRESENCE_STATUS: true,
                    JITSI_WATERMARK_LINK: '',          // Menghapus link pada watermark
                    DISABLE_JOIN_LEAVE_NOTIFICATIONS: true,
                    VERTICAL_FILMSTRIP: true,
                    VIDEO_LAYOUT_FIT: 'nocrop',
                }
            };

            jitsiApi = new JitsiMeetExternalAPI(domain, options);

            // Ensure responsiveness on window resize
            window.addEventListener('resize', () => {
                if (jitsiApi) {
                    const width = window.innerWidth;
                    const height = window.innerHeight;
                    // Force Jitsi to recognize the size change
                    const iframe = document.querySelector('iframe');
                    if (iframe) {
                        iframe.style.width = width + 'px';
                        iframe.style.height = height + 'px';
                    }
                }
            });

            // Initialize icons
            lucide.createIcons();

            // Event listeners
            jitsiApi.addEventListener('audioMuteStatusChanged', (event) => {
                isMicMuted = event.muted;
                updateMicButton();
            });
            jitsiApi.addEventListener('videoConferenceJoined', (event) => {
                console.log('Embed joined. My ID:', event.id);
                // Check if we need to pin someone who might already be there (though unlikely for a fresh joiner seeing others immediately via this event)
                checkAndPinParams();
            });

            jitsiApi.addEventListener('participantJoined', (event) => {
                console.log('Participant joined:', event);
                checkAndPin(event.id);
                // Also trigger the bulk check just in case we miss properties in the event
                setTimeout(checkAndPinParams, 500);
            });

            jitsiApi.addEventListener('participantLeft', (event) => {
                // If the pinned participant leaves, reset the state
                if (currentPinnedId && event.id === currentPinnedId) {
                    console.log('Pinned participant left. Resetting pin state.');
                    currentPinnedId = null;
                }
            });

            // Periodically check participants list just in case (sometimes race conditions occur)
            setInterval(() => {
                if (targetUserId) {
                    checkAndPinParams();
                }
            }, 5000);
        }

        async function checkAndPinParams() {

            if (!targetUserId) return;

            try {
                // Determine if targetUserId is likely an ID (short, no spaces) or a name/email
                // For now, let's assume if it looks like an ID we try pinning directly, BUT 
                // the requirement is specifically to check list of participants based on email/value.

                // Get all participants
                // The API might not return emails depending on the Jitsi instance privacy settings,
                // often it returns 'formattedDisplayName' or 'displayName'.
                // We will check both 'email (if available)' and 'displayName'.

                // jitsiApi.getParticipants() returns an array of objects
                // Note: external_api might expose this synchronously or via async access depending on version, usually it returns the list directly.
                let participants = jitsiApi.getParticipantsInfo();

                // If the API call returns a promise (some newer versions), await it.
                if (participants && typeof participants.then === 'function') {
                    participants = await participants;
                }

                if (!participants || participants.length === 0) return;

                // Find participant
                // The 'participants' from API is usually an Array of objects: { id, displayName, formattedDisplayName, ... }
                const target = participants.find(p =>
                    (p.email && p.email === targetUserId) ||
                    (p.displayName && p.displayName === targetUserId) ||
                    (p.formattedDisplayName && p.formattedDisplayName === targetUserId)
                );


                if (target) {
                    // VALIDATION: If we already pinned this user, do NOT pin again
                    // This prevents toggling (unpinning) or unnecessary commands when other users join
                    if (currentPinnedId === target.participantId) {
                        return;
                    }

                    console.log('Target found by name/email:', targetUserId, '--> Pinning ID:', target.participantId);
                    jitsiApi.executeCommand('pinParticipant', target.participantId);
                    currentPinnedId = target.participantId;
                } else {
                    // Fallback: If no name matched, maybe targetUserId WAS the ID itself?
                    // console.log('Target not found by name/email:', targetUserId);
                }

            } catch (e) {
                // alert(e)

                console.log("Error checking participants for pin:", e);
            }
        }

        function checkAndPin(id) {
            // optimized check for single join event if we want, but checkAndPinParams handles the logic centrally now
            checkAndPinParams();
        }

        function toggleMicrophone() {
            if (jitsiApi) {
                jitsiApi.executeCommand('toggleAudio');
                // The event listener will update the state
            }
        }

        function updateMicButton() {
            const micBtn = document.getElementById('micBtn');
            const micIcon = document.getElementById('micIcon');
            const micStatus = document.getElementById('micStatus');

            if (!micBtn) return; // Button might be commented out

            if (isMicMuted) {
                micBtn.classList.add('danger');
                micIcon.setAttribute('data-lucide', 'mic-off');
                micStatus.classList.remove('on');
                micStatus.classList.add('off');
            } else {
                micBtn.classList.remove('danger');
                micIcon.setAttribute('data-lucide', 'mic');
                micStatus.classList.remove('off');
                micStatus.classList.add('on');
            }
            lucide.createIcons();
        }
    </script>
</body>

</html>